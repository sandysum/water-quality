---
title: "CA SWRB monitoring and compliance data"
author: "Sandy Sum"
date: '`r Sys.Date()`'
output: 
html_document:
  theme: cosmo
  toc: true
  number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(error = FALSE)
knitr::opts_chunk$set(cache = FALSE)
knitr::opts_chunk$set(fig.align = "center")
library(cowplot)
library(tidyverse)
library(readr)
library(sf)
library(readxl)
library(readr)
library(lubridate)
library(ggplot2)
library(kableExtra)
library(DescTools)
library(Hmisc)
library(lfe)
library(DT)
home<- "/Volumes/GoogleDrive/My Drive/0Projects/1Water/2Quality/Data/"
```

```{r echo = FALSE}
ar <- read_rds(file.path(home, "1int/caswrb_ar_1974-2021.rds")) 

ni <-read_rds(file.path(home, "1int/caswrb_n_1974-2021.rds")) 
  
cv_counties <-c('Butte', 'Colusa', 'Glenn', 'Fresno', 'Kern', 'Kings', 'Madera', 'Merced', 'Placer', 'San Joaquin', 'Sacramento', 'Shasta', 'Solano', 'Stanislaus', 'Sutter', 'Tehama', 'Tulare', 'Yolo', 'Yuba') %>% str_to_lower()
pdsi <- read_rds("../../Data/drought/pdsi_pws_monthyear.rds")
```

# Contaminants and Summary {.tabset}

## Nitrate

There are 

* 9,897 PWSs with
* 26,577 unique sampling points which can be wells, surface water, or treated water
* Those sampling points also each have a status associated with them, one of `r ni$STATUS %>% unique()`

```{r}
ni_stat <- ni %>% 
  filter(!is.na(SYSTEM_NO)) %>% 
  group_by(SYSTEM_NO, WATER_TYPE, STATUS) %>% 
  dplyr::summarise(num_spid = length(unique(samplePointID))) %>% 
  arrange(SYSTEM_NO, desc(num_spid))
```

```{r,results='asis'}
DT::datatable(ni_stat)
```

## Arsenic

There are 

* 6,495 PWSs with
* 20,875 unique sampling points which can be wells, surface water, or treated water
* Those sampling points also each have a status associated with them, one of `r ni$STATUS %>% unique()`

```{r}
ar_stat <- ar %>% 
  filter(!is.na(SYSTEM_NO)) %>% 
  group_by(SYSTEM_NO, WATER_TYPE, STATUS) %>% 
  dplyr::summarise(num_spid = length(unique(samplePointID))) %>% 
  arrange(SYSTEM_NO, desc(num_spid))
```

```{r,results='asis'}
DT::datatable(ar_stat)
```

<!-- **Median Arsenic level (in raw sources) and PDSI (blue) for Tulare/Madera county** -->

<!-- ```{r echo = FALSE, fig.height= 4} -->
<!-- ar_my_drought %>%  -->
<!--   filter(countyName == "tulare", raw == 1) %>%  -->
<!--   ggplot(aes(date, median_ar)) + -->
<!--   geom_line() + -->
<!--   geom_line(aes(date, pdsi), color = 'blue') + -->
<!--   theme_minimal_hgrid() + -->
<!--   scale_x_date(date_breaks = "1 year", date_labels = "%Y") + -->
<!--   theme(axis.text.x = element_text(angle = 45, hjust = 0.9)) -->

<!-- ar_my_drought %>%  -->
<!--   filter(countyName == "madera", raw == 1) %>%  -->
<!--   ggplot(aes(date, median_ar)) + -->
<!--   geom_line() + -->
<!--   geom_line(aes(date, pdsi), color = 'blue') + -->
<!--   theme_minimal_hgrid() + -->
<!--   lims(y = c(-10, 75)) + -->
<!--   scale_x_date(date_breaks = "1 year", date_labels = "%Y") + -->
<!--   theme(axis.text.x = element_text(angle = 45, hjust = 0.9)) -->
<!-- ``` -->

# Datasets and Notes

### EPA Six-Year Review Monitoring and Compliance Data

- 1998-2005; 2006-2011
- Super set of the following

### CA SWRB Drinking Water Quality Data

- 1974-2021
- unbalanced

### EPA Enforcement and Compliance History Data for the Safe Water Drinking Act

The Safe Drinking Water Information System (SDWIS) contains information on public water systems from the Public Water System Supervision (PWSS) Program, including monitoring, enforcement, and violation data related to requirements established by the Safe Drinking Water Act (SDWA).

### PDSI Palmer's Drought Hydrological Data

This new experimental implementation of the Palmer Drought Severity Index (PDSI) updates every 5 days using the high-resolution gridMET gridded research dataset and USDA STATSGO soils data. The PDSI is a standardized index based on a simplified soil water balance and estimates relative soil moisture conditions. The magnitude of PDSI indicates the severity of the departure from normal conditions. A PDSI value >4 represents very wet conditions, while a PDSI <-4 represents an extreme drought. 

The PDSI for California at the PWS-month year level ranges from `r range(pdsi$mean_pdsi, na.rm = TRUE)`.

### CA CA Drinking Water System Area Boundaries

Obtained via email

Please be advised that this copy of the System Area Boundary Layer data is a snapshot of the CA drinking water system area boundaries provided to the State Board by individual water systems. A water system may have provided accurate, up-to-date boundaries, or may have provided boundaries that are only approximate. This layer does not contain all Public Water System boundaries. The dataset is in the process of being reviewed and verified. In addition, new boundaries are being added. Please note that these definitions are NOT a legal definition and should NOT be used to settle boundary disputes. Because the Water Board is targeting different information, there is no conflict with other authoritative agencies' definitions.

### USGS NWIS water monitoring data

- 1995-2020
- Small dataset and geographical coverage

# Compliance, Reporting, and Enforcement Rules

## Standardized Monitoring Framework

**Legend for the SMF Tables**

\* = 1 sample at each entry point to distribution system (EPTDS).

\*\* = 2 quarterly samples at each EPTDS. Samples must be taken during 1 calendar year during each 3-year compliance period.

\*\*\*\* = 4 quarterly samples at each EPTDS within time frame designated by the primacy agency.

X = No sample required unless specified by primacy agency. However, waivers must be renewed at the frequency shown and system must demonstrate that the sources are not vulnerable.

\# = Systems must monitor at a frequency specified by the primacy agency. Detect = Federally defined detection limit.

```{r pressure, echo=FALSE, fig.align="center", fig.cap="The EPA's standardized monitoring framework", out.width = '100%'}
knitr::include_graphics("../../PresentationMaterial/dw_smf.png")
```

(SMF) for inorganic contaminants (40CFR141.23) - the same rule applies to inorganic Nitrate $NO_3$.

- At each entry point of the distribution system 
  - *Entry Point to the Distribution System*: is where any source or treated water enters the system of pipes or other fixtures used to provide drinking water to persons served by the public water system
- Ground water systems – one sample every three years - must complete sampling by
December 31, 2007
- Surface water systems – one sample every year - must complete sampling by December 31, 2006
- Repeated values may mean for each entry point
- If a system is collecting samples more than once a year (i.e., quarterly or more), then compliance with the MCL is determined by calculating a Running Annual Average (RAA).
- If a system is collecting samples more than once a year (i.e., quarterly or more), then compliance with the MCL is determined by calculating a Running Annual Average
(RAA).
- Although it is not clearly stated in the rule, it is EPA’s position that systems
triggered into increased monitoring will not be considered in violation of the MCL
until they have completed one year of quarterly sampling. However, if any sample
result causes the RAA to exceed the MCL at any sampling point (e.g., the sampling
result is four times the MCL), the system is out of compliance with the MCL
immediately.

## The 2001 Final Arsenic Rule (FAR)

### General Description

Changes the arsenic MCL from 50 µg/L to 10 µg/L; Sets arsenic MCLG at 0; Requires monitoring for new systems and new drinking water sources; Clarifies the procedures for determining compliance with the MCLs for IOCs, SOCs, and VOCs.

### Timeline

The new Arsenic Rule applies to all community water systems (CWSs) and nontransient non-community water systems (NTNCWSs).

- By, January 22, 2004, all NEW systems/sources must collect initial monitoring samples for all IOCs, SOCs, and VOCs within a period and frequency determined by the State
- The MCL will remain at 50 ug/L until January 22, 2006
- On January 23, 2006, the revised MCL of 10 ug/L becomes enforceable, and all systems must begin monitoring or submit data that meets grandfathering requirements
- On December 31, 2006 Surface water systems must complete initial monitoring or have a State approved waiver.
- On December 31, 2007 Ground water systems must complete initial monitoring or have a State approved waiver

### Monitoring Requirements for Total Arsenic (1)

1. **Initial Monitoring**
One sample after the effective date of the MCL (January 23, 2006). Surface water systems must take annual samples. Ground water systems must take one sample between 2005 and 2007.
2. **Reduced Monitoring**
If the initial monitoring result for arsenic is less than the MCL:
  + Ground water systems must collect one sample every 3 years.
  + Surface water systems must collect annual samples.
3. **Increased Monitoring**
A system with a sampling point result above the MCL must collect quarterly samples at that sampling point, until the system is reliably and consistently below the MCL.

*(1) All samples must be collected at each entry point to the distribution system, unless otherwise specified by the State.*

## Some thoughts regarding leveraging the FAR

- This means that the rule applies to communities served by CWSs and NTNCWSs and not communities served by private wells
- The rule is only binding for CWSs who are experiencing Arsenic level $>10 \;ug/L$ in 2001, who likely had to upgrade their treatment systems
  - EPA estimates that 3,024 CWSs and 1,080 NTNCWSs will have to install treatment to comply with the revised MCL
- This rule is non-binding for CWSs who are not in the Arsenic "hot spot" which could be correlated to CWSs that has a portfolio of mainly surface water
- Identify CWSs that were non-binding at 2001 or prior to policy enforcement at 2006

# CWSs and monitoring in California

Each PWS (in dataset `sys`) has many monitoring locations denoted by their sampling point ID (in dataset `loc`). These monitoring locations can be anywhere in the system and are denoted in the dataset by their status number.

```{r echo=FALSE, fig.align="center", fig.cap="The EPA's standardized monitoring framework", out.width = '60%'}
knitr::include_graphics("../../PresentationMaterial/dw_sys_ex.png")
```


- Abandoned – AB
A source which is no longer being used, with no intention of being used in the future, and which is not destroyed.

- Destroyed – DS
A source which is filled and capped with no possibility of being used in the future.

- Inactive Raw – IR
A source which is not in service for periods of one year or greater and which provides raw water which is sampled before any treatment.

- Inactive Treated – IT
A source which is not in service for periods of one year or greater and which provides treated water to a system.

- Inactive Untreated – IU
A source which is not in service for periods of one year or greater and which provides raw water to a system without any treatment.

- Standby Raw – SR
A source which is used less than 15 calendar days per year, with periods not to exceed five consecutive days and which provides raw water which is sampled before any treatment.

- Standby Treated – ST
A source which is used less than 15 calendar days per year, with periods not to exceed five consecutive days and which provides raw water which is sampled after treatment.

- Standby Untreated – SU
A source which is used less than 15 calendar days per year, with periods not to exceed five consecutive days and which provides raw water without any treatment.

- Active Raw – AR
An active source which is sampled before any treatment.

- Active Treated – AT
An active source which is sampled after any treatment.

- Active Untreated – AU
An active source which is not treated.

- Monitoring – MW
A source, which is not a drinking water source and which is utilized only for monitoring water quality.

- Agricultural/Irrigation Well – AG
Not a drinking water well; utilized only for agriculture.

- Distribution system sample point, Treated – DT
Sample point within the distribution system after treatment.

- Distribution system sample point, Raw – DR
Sample point within the distribution system before treatment.

- Combined Treated - CT
Combined sources which are treated.

- Combined Untreated - CU
Combined sources which are not treated.

- Combined Raw - CR
Combined raw sources.

- Combined Mixed - CM
Combined sources.

- Pending – PN
Source not yet established.

- Purchased Raw – PR
Purchased source water which is sampled before any treatment.

- Purchased Treated – PT
Purchased source water which is sampled after any treatment.

- Purchased Untreated - PU
Purchased source water which is not treated.

- Waste Water – WW
Not for drinking 

There are a lot more systems in the CA SWRB data than in the file from the CA open data portal

<!-- ## Looking at plausibly drinking water trends -->

<!-- How to identify drinking water from untreated water? -->

<!-- For this I filtered to `STATUS %in% c("CT", "AT", "DT")`. To be more conservative I should have just looked at `DT` but that has very little data. -->

<!-- ```{r echo = TRUE} -->
<!-- kable(table(ar$STATUS), format = "html") -->
<!-- ``` -->

<!-- Looking at density of monitoring measures before and after the enforcement of the policy. Just a lot more observations after the policy in 2001.  -->

<!-- Need to run event study regression in R. -->

<!-- ```{r fig.align="center", fig.width=6, fig.height=4} -->
<!-- ar_pre_post <- ar %>% filter(STATUS %in% c("CT", "AT", "DT")) %>%  -->
<!--   mutate(pre_post_enforcement = case_when( -->
<!--     year < 2001 ~ "pre", -->
<!--     year > 2006 ~ "post", -->
<!--     TRUE ~ "transition" -->
<!--   )) %>%  -->
<!--   mutate(ar_ugl_win50 = Winsorize(ar_ugl, maxval = 50)) -->

<!-- ggplot(ar_pre_post, aes(x=ar_ugl_win50, fill=pre_post_enforcement)) + -->
<!--   # geom_density(alpha = .6) + -->
<!--   geom_histogram(alpha=0.55, bins = 50) + -->
<!--   geom_vline(xintercept = 10, color = "red") + -->
<!--   theme_minimal() -->
<!-- ``` -->

<!-- ## Firebaugh City  -->

<!-- Let's look at the time series of a single system/PWSID, serving 7,619 people that mainly sources from groundwater.  -->

<!-- ```{r, results='asis'} -->
<!-- #1010005-010 -->
<!-- ar %>%  -->
<!--   filter(SYSTEM_NO == "1010005") %>%  -->
<!--   group_by(samplePointID, STATUS, STATION_TY) %>%  -->
<!--   summarise(n_obs_each_pt = n()) %>%   -->
<!--   kable(format = "html") -->
<!-- ``` -->

<!-- We can keep just the `CT` and `AR` -->

<!-- ```{r fig.align="center", fig.width=10, fig.height=5} -->
<!-- #1010005-010 -->
<!-- ar %>%  -->
<!--   filter(SYSTEM_NO == "1010005", STATUS %in% c('CT', 'AR')) %>%  -->
<!--   ggplot(aes(sampleDate, ar_ugl, color = samplePointID)) + -->
<!--   geom_point() + -->
<!--   geom_hline(yintercept = 10, color = 'red') + -->
<!--   geom_vline(xintercept = dmy('23012006'), color = "blue") + -->
<!--   geom_smooth() + -->
<!--   theme_minimal() + -->
<!--   facet_grid(cols = vars(STATUS)) + -->
<!--   scale_color_brewer(palette = "Dark2") + -->
<!--   scale_x_date(date_breaks = '1 year', date_labels = "%Y") + -->
<!--   theme(axis.text.x = element_text(angle = 45), legend.position = 'top') -->
<!-- ``` -->


<!-- ## Visalia City -->

<!-- Serves 140,868. There are many sampling points for this location! But many are destroyed. Have to do guesswork as to which one is plausibly going into drinking water. -->

<!-- ```{r, results='asis'} -->
<!-- #140868 -->
<!-- ar %>%  -->
<!--   filter(SYSTEM_NO == "5410016") %>%  -->
<!--   group_by(samplePointID, STATUS, STATION_TY) %>%  -->
<!--   summarise(n_obs_each_pt = n()) %>%   -->
<!--   kable(format = 'html', booktabs = T) -->
<!-- ``` -->

<!-- There are too many sample points, so let's filter to those with more than 16. But this runs the risk of sampling only the high arsenic or flouting ones. It could be flouting the MCL of *other* contaminants too, because under the SMF, the resampling schedule applies to other contaminants. -->

<!-- ```{r fig.align="center", fig.width=10, fig.height=5} -->
<!-- #1010005-010 -->
<!-- ar %>%  -->
<!--   group_by(samplePointID) %>%  -->
<!--   filter(SYSTEM_NO == "5410016", STATUS %in% c('AU', 'AR', 'AT'), n() > 16) %>%  -->
<!--   ggplot(aes(sampleDate, ar_ugl, color = samplePointID)) + -->
<!--   geom_point() + -->
<!--   geom_hline(yintercept = 10, color = 'red') + -->
<!--   geom_vline(xintercept = dmy('23012006'), color = "blue") + -->
<!--   geom_smooth(alpha = .5) + -->
<!--   theme_minimal() + -->
<!--   facet_grid(cols = vars(STATUS)) + -->
<!--   scale_color_brewer(palette = "Dark2") + -->
<!--   scale_x_date(date_breaks = '1 year', date_labels = "%Y") + -->
<!--   theme(axis.text.x = element_text(angle = 45), legend.position = 'top') -->
<!-- ``` -->

<!-- This city doesn't have a lot of treated data. but maybe it has a working treatment plant and has obtained the waiver. -->

<!-- ```{r, results='asis'} -->
<!-- #1010005-010 -->
<!-- ar %>%  -->
<!--   group_by(samplePointID) %>%  -->
<!--   filter(SYSTEM_NO == "5410016", STATUS %in% c('AT')) %>%  -->
<!--   kable(format = 'html') -->
<!--   # ggplot(aes(sampleDate, ar_ugl, color = samplePointID)) + -->
<!--   # geom_point() + -->
<!--   # geom_hline(yintercept = 10, color = 'red') + -->
<!--   # geom_vline(xintercept = dmy('23012006'), color = "blue") + -->
<!--   # geom_smooth(alpha = .5) + -->
<!--   # theme_minimal() + -->
<!--   # facet_grid(cols = vars(STATUS)) + -->
<!--   # scale_color_brewer(palette = "Dark2") + -->
<!--   # scale_x_date(date_breaks = '1 year', date_labels = "%Y") + -->
<!--   # theme(axis.text.x = element_text(angle = 45), legend.position = 'top') -->
<!-- ``` -->
