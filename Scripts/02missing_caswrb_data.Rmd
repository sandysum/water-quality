---
title: "CA SWRB describe and fix missing data"
author: "Sandy Sum"
date: '`r Sys.Date()`'
output: 
html_document:
  number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(error = FALSE)
knitr::opts_chunk$set(cache = FALSE)
knitr::opts_chunk$set(fig.align = "center")
library(zoo)
library(knitr)
library(papeR)
library(cowplot)
library(tidyverse)
library(readr)
library(readxl)
library(sf)
library(lubridate)
library(ggplot2)
library(kableExtra)
library(DescTools)
library(lfe)
library(xtable)
home<- "/Volumes/GoogleDrive/My Drive/0Projects/1Water/2Quality/Data"
```

```{r echo = FALSE}
# read in data
sys <- read_xlsx(file.path(home, "ca_water_qual/watsys.xlsx")) 
loc <- read_xlsx(file.path(home, "ca_water_qual/siteloc.xlsx")) %>% 
  mutate(STATUS = str_to_upper(STATUS))
# read arsenic and nitrate data from the CA SWRB portal 
# read arsenic and nitrate data from the CA SWRB portal 
# read arsenic and nitrate data from the CA SWRB portal 
ar <- read_rds(file.path(home, "1int/caswrb_ar_1974-2021.rds")) 

ni <- read_rds(file.path(home, "1int/caswrb_n_1974-2021.rds"))

cv_counties <-  c('Butte', 'Colusa', 'Glenn', 'Fresno', 'Kern', 'Kings', 'Madera', 'Merced', 'Placer', 'San Joaquin', 'Sacramento', 'Shasta', 'Solano', 'Stanislaus', 'Sutter', 'Tehama', 'Tulare', 'Yolo', 'Yuba') %>% str_to_lower()

pws_land <- read_sf("../../Data/1int/pws_sf_clay_ph.shp")
pws <- read_sf("../../Data/shp_PWS_SABL_Public_080221/SABL_Public_080221.shp")

dww <- read_csv("../../Data/ca_drinkingwatersystems_meta.csv")
```

# Summary of monitoring data so far

There are `r length(unique(ar$SYSTEM_NO))` number of Public Water Systems (PWSs) in the CA AWRB monitoring data files with Arsenic monitoring data from `r min(ar$year, na.rm = TRUE)` to `r  max(ar$year, na.rm = TRUE)`. 

```{r}
ar %>% 
  filter(!is.na(SYSTEM_NO)) %>% 
  group_by(SYSTEM_NO, WATER_TYPE, STATUS) %>% 
  summarise(num_spid = length(unique(samplePointID))) %>% 
  arrange(desc(num_spid))
```


```{r echo = FALSE, fig.height=4, fig.width=4.5}
pws_summary <- ar %>% 
  group_by(SYSTEM_NO) %>% 
  dplyr::summarise(freq = n(),
                   n_samplingloc = n_distinct(samplePointID), 
                   mean_ar = mean(ar_ugl, na.rm = TRUE), 
                   min_year = min(year, na.rm = TRUE),
                   max_year = max(year, na.rm = TRUE),
                   Population = POP_SERV[1],
                   Connection = CONNECTION[1]
                   ) %>% 
  arrange(freq) %>% 
  mutate(mean_ar = Winsorize(mean_ar, probs = c(0, .99)))

# pws_summary %>% ggplot(aes(mean_ar, freq)) +
#   geom_point(alpha = .7) +
#   theme_minimal_grid() +
#   lims(y = c(0, 6000))
```

### Individual PWS Arsenic monitoting data: Summary statistic

```{r echo = FALSE, results = 'asis'}
labels(pws_summary) <- c('PWS ID', '# arsenic sample', '# unique sampling points', 'Mean Arsenic (ug/l)', 'Year of first sample', 'Year of last sample', 'Population served', '# Connections')
papeR::summarise(pws_summary) 
```

Each PWS has from 1 to over 400 unique sampling point ID. 

In my data, I am able to document if the sampling point correspond to a raw or treated source within a PWS.

```{r results='asis'}
papeR::summarise(ar %>% mutate(raw = factor(raw)), type = 'numeric', group = 'raw', variables = "ar_ugl") 
papeR::summarise(ni %>% mutate(raw = factor(raw)), type = 'numeric', group = 'raw', variables = "n_mgl") 
```

### How many PWSs has a shapefile boundary?

*Note* Please be advised that this copy of the System Area Boundary Layer data is a snapshot of the CA drinking water system area boundaries provided to the State Board by individual water systems. A water system may have provided accurate, up-to-date boundaries, or may have provided boundaries that are only approximate. This layer does not contain all Public Water System boundaries. The dataset is in the process of being reviewed and verified. In addition, new boundaries are being added. Please note that these definitions are NOT a legal definition and should NOT be used to settle boundary disputes.

In lieu of what was said above, I am not sure if I should use the PWS shapfile boundaries to match drought, clay layer, landuse, and ph data. Would I lose a lot of PWS data if they did not submit a shapefile boundary? It also seems like smaller and lower income PWSs would not have the capability to submit shapefiles...

Someday I will do additional work to match the PWS with no shapefiles to the zipcode...

```{r include = FALSE}
ar <- ar %>% mutate(has_shp = SYSTEM_NO %in% str_extract(pws$SABL_PWSID, "\\d+"))
ni <- ni %>% mutate(has_shp = SYSTEM_NO %in% str_extract(pws$SABL_PWSID, "\\d+"))
ar$has_shp %>% table() 
ar %>% filter(!has_shp) %>% dplyr::select(SYSTEM_NO) %>% unique()
```

```{r results='asis', include=FALSE}
papeR::summarise(ar %>% mutate(has_shp = factor(has_shp)), type = 'numeric', group = 'has_shp', variables = "ar_ugl") 
papeR::summarise(ni %>% mutate(has_shp = factor(has_shp)), type = 'numeric', group = 'has_shp', variables = "n_mgl") 
```

The total number of observations we would drop is $\frac{40896}{321696} \approx 11.3\%$, which is not ideal. That would be dropping 2,708 PWSs too. 


### How frequent does each PWS samples? Is it tied to Arsenic level?

- Frequency of sampling by each PWS is loosely tied to mean Arsenic level
- Not representative as some PWS might have many many connections or source, and hence is over represented if we just look at counts


```{r echo = FALSE}
clay_ph <- pws_land %>% 
  as_data_frame() %>% 
  mutate(SYSTEM_NO = str_extract(SABL_PWSID, "\\d+"),
         ph_grp = cut_interval(ph, 3),
         clay_grp = cut_number(clay, 3)) 
levels(clay_ph$ph_grp) <- c('low', 'med', 'high')
levels(clay_ph$clay_grp) <- c('low', 'med', 'high')

ar_py <- ar %>%
  # filter only to groundwater and raw sources
  filter(WATER_TYPE == "G", raw == 1) %>%
  mutate(month = month(sampleDate),
         cv = if_else(countyName %in% cv_counties, 1, 0)) %>%
  group_by(
    SYSTEM_NO,
    year,
    countyName,
    cv,
    DISTRICT,
    CITY,
    POP_SERV,
    ZIP,
    ZIP_EXT,
    CONNECTION,
    AREA_SERVE
  ) %>%
  # Winsorize as per Shapiro (2021 paper)
  dplyr::summarise(
    median_ar = median(ar_ugl, na.rm = TRUE),
    mean_ar = mean(ar_ugl, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  mutate(mean_ar = Winsorize(mean_ar, probs = c(0, .99))) %>% 
  left_join(clay_ph) %>% 
  drop_na(ph, clay)

ar_p <- ar %>%
  # filter only to groundwater and raw sources
  filter(WATER_TYPE == "G", raw == 1) %>%
  mutate(month = month(sampleDate),
         cv = if_else(countyName %in% cv_counties, 1, 0)) %>%
  group_by(
    SYSTEM_NO,
    # year,
    countyName,
    cv,
    DISTRICT,
    CITY,
    POP_SERV,
    ZIP,
    ZIP_EXT,
    CONNECTION,
    AREA_SERVE
  ) %>%
  # Winsorize as per Shapiro (2021 paper)
  dplyr::summarise(
    median_ar = median(ar_ugl, na.rm = TRUE),
    mean_ar = mean(ar_ugl, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  mutate(mean_ar = Winsorize(mean_ar, probs = c(0, .99))) %>% 
  left_join(clay_ph) %>% 
  drop_na(ph, clay)

ar_p %>% ggplot(aes(mean_ar)) +
  geom_density(aes(color = clay_grp)) +
  theme_minimal_grid()

ar_p %>% ggplot(aes(mean_ar)) +
  geom_density(aes(color = ph_grp)) +
  theme_minimal_grid()

ar_p %>% ggplot(aes(median_ar)) +
  geom_density(aes(color = clay_grp)) +
  theme_minimal_grid()

ar_p %>% ggplot(aes(median_ar)) +
  geom_density(aes(color = ph_grp)) +
  theme_minimal_grid()

mod <- felm(mean_ar ~ ph+clay | SYSTEM_NO | 0 | 0, data = ar_p)

```

## Look at frequency of Ar monitoring by PWS

A lot does have annual data! I reckon I can get away with interpolating if gaps are less than 3 years apart.

```{r, fig.asp = .7}
set.seed(1898)
ar_py %>%
  dplyr::filter(SYSTEM_NO %in% sample(ar_py$SYSTEM_NO, 6)) %>%
  ggplot(aes(
    year,
    mean_ar,
    color = factor(SYSTEM_NO)
  )) +
  geom_line() +
  geom_point(aes(
    year,
    mean_ar,
    color = factor(SYSTEM_NO),
  ), size = 2) +
  geom_vline(xintercept = 2006) +
  geom_hline(yintercept = 10, color = 'red') +
  theme_minimal_vgrid() +
  scale_x_continuous(breaks = 1980:2022) +
  scale_color_brewer(palette = 'Dark2') +
  theme(axis.text.x = element_text(angle = 45, vjust = .9, hjust = .9, size = 8), legend.key.size = unit(1, 'cm'), legend.position = 'top')
```


```{r, fig.asp = .7}
set.seed(5347)
ar_py %>%
  dplyr::filter(SYSTEM_NO %in% sample(ar_py$SYSTEM_NO, 6)) %>%
  ggplot(aes(
    year,
    mean_ar,
    color = factor(SYSTEM_NO)
  )) +
  geom_line() +
  geom_point(aes(
    year,
    mean_ar,
    color = factor(SYSTEM_NO),
  ), size = 2) +
  geom_vline(xintercept = 2006) +
  geom_hline(yintercept = 10, color = 'red') +
  theme_minimal_vgrid() +
  scale_x_continuous(breaks = 1980:2022) +
  scale_color_brewer(palette = 'Dark2') +
  theme(axis.text.x = element_text(angle = 45, vjust = .9, hjust = .9, size = 8),legend.key.size = unit(1, 'cm'), legend.position = 'top')
```

```{r, fig.asp=.7}
set.seed(8467)
ar_py %>%
  dplyr::filter(SYSTEM_NO %in% sample(ar_py$SYSTEM_NO, 6)) %>%
  ggplot(aes(
    year,
    mean_ar,
    color = factor(SYSTEM_NO)
  )) +
  geom_line() +
  geom_point(aes(
    year,
    mean_ar,
    color = factor(SYSTEM_NO),
  ), size = 2) +
  geom_vline(xintercept = 2006) +
  geom_hline(yintercept = 10, color = 'red') +
  theme_minimal_vgrid() +
  scale_x_continuous(breaks = 1980:2022) +
  scale_color_brewer(palette = 'Dark2') +
  theme(axis.text.x = element_text(angle = 45, vjust = .9, hjust = .9, size = 8), legend.key.size = unit(1, 'cm'), legend.position = 'top')
```

```{r}
# prepping data for interpolation
comb <- expand_grid(unique(ar_py$SYSTEM_NO), 1974:2021) 
names(comb) <- c('SYSTEM_NO', 'year')

ar_py <- left_join(comb, ar_py) %>% 
  group_by(SYSTEM_NO) %>% 
  fill_(c("countyName", "cv", "DISTRICT" , "CITY", "POP_SERV", "ZIP", "ZIP_EXT", "CONNECTION" ,"AREA_SERVE"), "downup")
```


### Interpolation 1

Wow the spline would give very different values...

```{r fig.asp = .7}
# interpolate max gap of 3
chk <- ar_py %>% filter(SYSTEM_NO == 4210003)

# interpolate max gap of 2

chk_int_lin <- chk %>% arrange(year) %>% 
  ungroup() %>% 
  mutate(mean_ar = na.approx(mean_ar, maxgap = 2, na.rm = FALSE))
chk_int_sp <- chk %>% arrange(year) %>% 
  ungroup() %>% 
  mutate(mean_ar = na.spline(mean_ar, maxgap = 2, na.rm = FALSE))

ggplot(chk_int_lin, aes(year, mean_ar)) +
  geom_point(data = chk, color = 'red', shape = 4, size = 3) +
  geom_line(data = chk_int_sp, color = 'green', size = 1.5, alpha = .6) +
   geom_line(color = 'blue', size = 1.5, alpha = .6) +
  theme_minimal_vgrid() +
  scale_x_continuous(breaks = 1974:2021) +
   theme(axis.text.x = element_text(angle = 45, vjust = .9, hjust = 1, size = 8))

```

### Interpolation 2

```{r fig.asp = .7}
# interpolate max gap of 3
chk <- ar_py %>% filter(SYSTEM_NO == 2000202)

# interpolate max gap of 2

chk_int_lin <- chk %>% arrange(year) %>% 
  ungroup() %>% 
  mutate(mean_ar = na.approx(mean_ar, maxgap = 2, na.rm = FALSE))
chk_int_sp <- chk %>% arrange(year) %>% 
  ungroup() %>% 
  mutate(mean_ar = na.spline(mean_ar, maxgap = 2, na.rm = FALSE))

ggplot(chk_int_lin, aes(year, mean_ar)) +
  geom_point(data = chk, color = 'red', shape = 4, size = 3) +
  geom_line(data = chk_int_sp, color = 'green', size = 1.5, alpha = .6) +
  geom_line(color = 'blue', size = 1.5, alpha = .6) +
  theme_minimal_vgrid() +
  scale_x_continuous(breaks = 1974:2021) +
   theme(axis.text.x = element_text(angle = 45, vjust = .9, hjust = 1, size = 8))

```

### Interpolation 3

```{r}
chk <- ar_py %>% filter(SYSTEM_NO == 1500006)

# interpolate max gap of 2

chk_int_lin <- chk %>% arrange(year) %>% 
  ungroup() %>% 
  mutate(mean_ar = na.approx(mean_ar, maxgap = 2, na.rm = FALSE))
chk_int_sp <- chk %>% arrange(year) %>% 
  ungroup() %>% 
  mutate(mean_ar = na.spline(mean_ar, maxgap = 2, na.rm = FALSE))

ggplot(chk_int_lin, aes(year, mean_ar)) +
  geom_point(data = chk, color = 'red', shape = 4, size = 3) +
  geom_line(data = chk_int_sp, color = 'green', size = 1.5, alpha = .6) +
  geom_line(color = 'blue', size = 1.5, alpha = .6) +
  theme_minimal_vgrid() +
  scale_x_continuous(breaks = 1974:2021) +
   theme(axis.text.x = element_text(angle = 45, vjust = .9, hjust = 1, size = 8))
```

I think that I will interpolate with the spline and then drop system no with less than X consecutive number of observation.

## Interpolating as a group

```{r}
# drop the duplicates!

ar <- ar %>% distinct(samplePointID, SYSTEM_NO, sampleDate, sampleTime, ar_ugl, .keep_all = TRUE)

ar_py <- ar %>%
  # filter only to groundwater and raw sources
  # star from year 1984, when there are more data points..
  filter(WATER_TYPE == "G", raw == 1, year > 1983) %>%
  mutate(month = month(sampleDate),
         cv = if_else(countyName %in% cv_counties, 1, 0)) %>%
  group_by(
    SYSTEM_NO,
    year,
    countyName,
    cv,
    DISTRICT,
    CITY,
    POP_SERV,
    ZIP,
    ZIP_EXT,
    CONNECTION,
    AREA_SERVE
  ) %>%
  # Winsorize as per Shapiro (2021 paper)
  dplyr::summarise(
    median_ar = median(ar_ugl, na.rm = TRUE),
    mean_ar = mean(ar_ugl, na.rm = TRUE)
  ) %>%
  # drop PWSs with only one observation
  group_by(SYSTEM_NO) %>%
  filter(n()>1) %>%
  ungroup() %>%
  mutate(mean_ar = Winsorize(mean_ar, probs = c(0, .99)))

# prepping data for interpolation
comb <- expand_grid(unique(ar_py$SYSTEM_NO), 1984:2021) 
names(comb) <- c('SYSTEM_NO', 'year')

ar_py <- left_join(comb, ar_py) %>% 
  group_by(SYSTEM_NO) %>% 
  fill_(c("countyName", "cv", "DISTRICT" , "CITY", "POP_SERV", "ZIP", "ZIP_EXT", "CONNECTION" ,"AREA_SERVE"), "downup")

# now we interpolate the data, but keep max gap at 2

ar_py_int <- ar_py %>% 
  arrange(SYSTEM_NO, year) %>% 
  group_by(SYSTEM_NO) %>%
  mutate(true = if_else(is.na(mean_ar), "true value", "interpolated"),
         mean_ar = na.spline(mean_ar, 
                             maxgap = 2,
                             na.rm = FALSE))

ar_py_int_all <- ar_py %>% 
  arrange(SYSTEM_NO, year) %>% 
  group_by(SYSTEM_NO) %>%
  mutate(true = if_else(is.na(mean_ar), "true value", "interpolated"),
         mean_ar = na.spline(mean_ar, 
                             # maxgap = 2,
                             na.rm = FALSE))
```

Plot the results

```{r}
set.seed(42)
ar_sub <- ar_py_int %>% filter(SYSTEM_NO %in% sample(ar_py$SYSTEM_NO, 6))
ggplot(ar_sub, aes(year, mean_ar, shape = true, color = factor(SYSTEM_NO))) +
  geom_point(size = 3) +
  # geom_line(data = chk_int_sp, color = 'green', size = 1.5, alpha = .6) +
  geom_line(size = 1.5, alpha = .6, aes(group=SYSTEM_NO)) +
  theme_minimal_vgrid() +
  scale_x_continuous(breaks = 1974:2021) +
   theme(axis.text.x = element_text(angle = 45, vjust = .9, hjust = 1, size = 8))

```

Comparing interpolating max.gap to be 2 and all... this is crazy. This should be a caution.

```{r}
set.seed(86)
ar_sub <- ar_py_int %>% filter(SYSTEM_NO %in% sample(ar_py$SYSTEM_NO, 6))
g2 <- ggplot(ar_sub, aes(year, mean_ar, shape = true, color = factor(SYSTEM_NO))) +
  geom_point(size = 3) +
  # geom_line(data = chk_int_sp, color = 'green', size = 1.5, alpha = .6) +
  geom_line(size = 1.5, alpha = .6, aes(group=SYSTEM_NO)) +
  theme_minimal_vgrid() +
  scale_x_continuous(breaks = 1974:2021) +
   theme(axis.text.x = element_text(angle = 45, vjust = .9, hjust = 1, size = 8))
set.seed(86)
ar_sub_all <- ar_py_int_all %>% filter(SYSTEM_NO %in% sample(ar_py$SYSTEM_NO, 6))
g_all <- ggplot(ar_sub_all, aes(year, mean_ar, shape = true, color = factor(SYSTEM_NO))) +
  geom_point(size = 3) +
  # geom_line(data = chk_int_sp, color = 'green', size = 1.5, alpha = .6) +
  geom_line(size = 1.5, alpha = .6, aes(group=SYSTEM_NO)) +
  theme_minimal_vgrid() +
  scale_x_continuous(breaks = 1974:2021) +
   theme(axis.text.x = element_text(angle = 45, vjust = .9, hjust = 1, size = 8))

```

Looking at another instance with max gap = 2

```{r fig.asp= .8}
plot_grid(g2, g_all, nrow = 2, scale = 1)
```


